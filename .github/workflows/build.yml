name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches: [ main, master ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.21'
  GOSEC_VERSION: 'v2.17.0'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run tests and coverage
      run: go test -v ./tests/... -coverprofile=coverage.out -covermode=atomic

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella

    - name: Run go vet
      run: go vet ./...

    - name: Run go fmt check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "The following files are not formatted:"
          gofmt -s -l .
          exit 1
        fi

    - name: Run Gosec Security Scanner
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: '-no-fail -fmt sarif -out results.sarif ./...'

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: results.sarif

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            output: bbdown-linux-amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            output: bbdown-linux-arm64
          - os: ubuntu-latest
            goos: linux
            goarch: 386
            output: bbdown-linux-386
          
          # macOS
          - os: macos-latest
            goos: darwin
            goarch: amd64
            output: bbdown-darwin-amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            output: bbdown-darwin-arm64
          
          # Windows
          - os: windows-latest
            goos: windows
            goarch: amd64
            output: bbdown-windows-amd64.exe
          - os: windows-latest
            goos: windows
            goarch: 386
            output: bbdown-windows-386.exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-${{ matrix.goos }}-${{ matrix.goarch }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.goos }}-${{ matrix.goarch }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o ${{ matrix.output }} main.go

    - name: Verify binary
      run: |
        if [ "${{ matrix.os }}" != "windows-latest" ]; then
          file ${{ matrix.output }}
          ls -la ${{ matrix.output }}
        fi

    - name: Create archive (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        tar -czf ${{ matrix.output }}.tar.gz ${{ matrix.output }}
        sha256sum ${{ matrix.output }}.tar.gz > ${{ matrix.output }}.tar.gz.sha256

    - name: Create archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path ${{ matrix.output }} -DestinationPath ${{ matrix.output }}.zip
        (Get-FileHash ${{ matrix.output }}.zip -Algorithm SHA256).Hash | Out-File ${{ matrix.output }}.zip.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.output }}-artifacts
        path: |
          ${{ matrix.output }}.*
        retention-days: 30

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        mkdir -p release
        find artifacts -name "*.tar.gz" -exec cp {} release/ \;
        find artifacts -name "*.zip" -exec cp {} release/ \;
        find artifacts -name "*.sha256" -exec cp {} release/ \;
        ls -la release/

    - name: Generate release notes
      id: release_notes
      run: |
        # æå–ç‰ˆæœ¬å·
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        cat > release_notes.md << EOF
        ## ðŸš€ BBDown Goç‰ˆæœ¬ $VERSION å‘å¸ƒ
        
        ### ðŸ“¦ ä¸‹è½½æ–‡ä»¶è¯´æ˜Ž
        - \`bbdown-linux-amd64.tar.gz\`: Linux x86_64 ç³»ç»Ÿ
        - \`bbdown-linux-arm64.tar.gz\`: Linux ARM64 ç³»ç»Ÿ (æ ‘èŽ“æ´¾ç­‰)
        - \`bbdown-linux-386.tar.gz\`: Linux x86 ç³»ç»Ÿ
        - \`bbdown-darwin-amd64.tar.gz\`: macOS Intel ç³»ç»Ÿ
        - \`bbdown-darwin-arm64.tar.gz\`: macOS Apple Silicon (M1/M2) ç³»ç»Ÿ
        - \`bbdown-windows-amd64.exe.zip\`: Windows x86_64 ç³»ç»Ÿ
        - \`bbdown-windows-386.exe.zip\`: Windows x86 ç³»ç»Ÿ
        
        ### ðŸ” æ–‡ä»¶æ ¡éªŒ
        æ‰€æœ‰ä¸‹è½½æ–‡ä»¶éƒ½åŒ…å«å¯¹åº”çš„ SHA256 æ ¡éªŒæ–‡ä»¶ï¼Œè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
        \`\`\`bash
        sha256sum -c bbdown-*.sha256
        \`\`\`
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
        2. è§£åŽ‹èŽ·å¾—å¯æ‰§è¡Œæ–‡ä»¶
        3. (Linux/macOS) \`chmod +x bbdown\`
        4. è¿è¡Œ \`./bbdown --help\` æŸ¥çœ‹å¸®åŠ©
        
        ### ðŸ“š æ›´å¤šä¿¡æ¯
        - [ä½¿ç”¨æ–‡æ¡£](https://github.com/tekintian/go-bbdown#readme)
        - [é—®é¢˜åé¦ˆ](https://github.com/tekintian/go-bbdown/issues)
        
        ---
        **æ³¨æ„**: æœ¬å·¥å…·ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚
        EOF
        
        # è®¾ç½®è¾“å‡º
        {
          echo "release_notes<<EOF"
          cat release_notes.md
          echo "EOF"
        } >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: BBDown Goç‰ˆæœ¬ ${{ steps.release_notes.outputs.version }}
        body: ${{ steps.release_notes.outputs.release_notes }}
        files: |
          release/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: bbdown/go-bbdown
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          latest

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ github.ref_name }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          COMMIT_SHA=${{ github.sha }}

  update-homebrew:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Update Homebrew formula
      uses: dawidd6/action-homebrew-bump-formula@v3
      with:
        token: ${{ secrets.HOMEBREW_TOKEN }}
        formula: bbdown
        force: true